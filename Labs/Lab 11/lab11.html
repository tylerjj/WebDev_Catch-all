<!DOCTYPE html>
	<html lang="en">
	<head>
		<title>Lab 11 Login</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://localhost:5000/socket.io/socket.io.js"></script>
        <style>
            .loginDiv {
                display: block;
                font-family:monospace;
            }
            .loginFailed {
                visibility:hidden;
                color:crimson;
            }
            .postDiv {
                display: none;
                font-family:monospace;
            }
        </style>
        </head>
    <body>
        <div class = "loginDiv" id = "loginDiv">
            <h1>
                Lab 11 Login Div
            </h1>
            <p class="loginFailed" id="loginFailed">Username/Password not found. Please try again.</p>
            <input type="text" name = "username" placeholder="Username" id="username">
            <input type="text" name = "password" placeholder="Password" id="password">
            <button class = "submitButton" id = "submitButton">Submit</button>
        </div>
        <div class = "postDiv" id = "postDiv">
            <h1>
                Lab 11 Post Div
            </h1>
            <div id="postListDiv"></div>
                <dl id="postList">
                </dl>
            <div id="onlineListDiv">
                <ul id="onlineList">
                </ul>
            </div>
            
            <button class = "makePostButton" id = "makePostButton">Make a Post</button>
            <button class = "logoutButton" id = "logoutButton">Logout</button>
        </div>
        </body>
    <script>
$(document).ready(function() {
    
    /** SOCKETS BLOCK **/
        //Connect to websocket server.
        var socket = io.connect('ws://localhost:5000');
        
        //Listen for what to do after a login attempt.
        socket.on('loginResponse', function(loginSuccess) {
            if (loginSuccess) {
                console.log("Login successful.");
                onLoginSuccess();
            } else onLoginFailure();
        });
    
        // Listen for data to initialize page.
        socket.on('initializePage', function(data){
            
        });
    
        // Listen for data to alter post list.
        socket.on('updatePostList', function(data){
            console.log("Data: "+data);
            var postsList = JSON.parse(data);
            var items = [];
            for (var item in usersList["post"]){
                var value = "<li>"+postsList["post"][item]+"</li>";
                console.log("Item in user list: " + usersList["post"][item]);
                items.push(value);
            }
            $('#onlineList').empty();
            $('#onlineList').append(items);            
        });
    
        // Listen for data to alter online users list.
        socket.on('updateOnlineUsersList', function(data){
            console.log("Data: "+data);
            var usersList = JSON.parse(data);
            var items = [];
            for (var item in usersList["onlineUsers"]){
                var value = "<li>"+usersList["onlineUsers"][item]+"</li>";
                console.log("Item in user list: " + usersList["onlineUsers"][item]);
                items.push(value);
            }
            $('#onlineList').empty();
            $('#onlineList').append(items);
        });
    
        console.log("Socket handlers have been set up.");
    
    /** BUTTON HANDLERS BLOCK **/
    
        // Submit button handler (submits a login attempt)
        $('#submitButton').click(function() {
            //Get username and password. 
            var uname = $('#username').val();
            var pword = $('#password').val();
            console.log("username and password: "+uname+", "+pword);
            //get password/username from loginDiv
            if ((uname ==null || uname =="") || 
                (pword ==null || pword=="")) {
                alert("Username and password must be filled out");
                return false;
            }
            
            var loginJSONObj = {
                "username": uname,
                "password": pword
            };
            
            var loginJSONStr = JSON.stringify(loginJSONObj);
            
            console.log("JSON Obj: "+loginJSONObj);
            console.log("JSON String: "+loginJSONStr);
            //websocket check to server
            socket.emit('validateLogin', loginJSONStr);

            console.log("validateLogin was emitted.");
            return;
        });
    
        // Logout button handler.
        $('#logoutButton').click(function(){
            var uname = $('#username').val();
            var usernameJSONStr = JSON.stringify({"username":uname});
            socket.emit('logout', usernameJSONStr,function(){
                console.log("Logout successful.");
            });
            onLogoutSuccess();
        });
    
        function onLoginSuccess() {
            document.getElementById("loginDiv").style.display="none";
            document.getElementById("postDiv").style.display="block";
        }
        function onLoginFailure() {
            document.getElementById("loginFailed").style.visibility="visible";
        }
    
    
        function displayPostList(arr) {

        }
        function appendPost(author, message) {

        }
        function displayOnlineList(arr) {
            var out = "";
            var i;
            for(i = 0; i<arr.length; i++) {
                out += arr[i].display + '<br>';
            }
            document.getElementById("onlineListDiv").innerHTML = out;
        }
        function logout() {
            //websocket update to server
            onLogoutSuccess();
        }
        function onLogoutSuccess() {
            document.getElementById("postDiv").style.display="none";
            document.getElementById("loginDiv").style.display="block";
            document.getElementById("loginFailed").style.visibility="hidden";
        }
        socket.on('loginResponse', function(loginSuccess) {
            if (loginSuccess) {
                onLoginSuccess();
            } else onLoginFailure();
        });
        socket.on('initializePage', function(data){
            
        });
        socket.on('updatePostList', function(data){
            
        });
        socket.on('updateOnlineUsersList', function(data){
            
        });
});
        </script>
</html>