<!DOCTYPE html>
	<html lang="en">
	<head>
		<title>Lab 11 Login</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://localhost:5000/socket.io/socket.io.js"></script>
        <style>
            .loginDiv {
                display: block;
                font-family:monospace;
            }
            .loginFailed {
                visibility:hidden;
                color:crimson;
            }
            #postDiv {
                /*background-color:yellow;*/
                display: none;
                font-family:monospace;
            }
            #leftHalfDiv{
                float:left;
                font-weight:bold;
            }
            #centerDiv {
                float:none;
            }
            #rightHalfDiv {
                /*background-color:darkmagenta;*/
                float:right;
            }
            .logoutButton {
                float:right;
            }
            #postListDiv {
                float:left;
                color:black;
                font-size:24px;
            }
            .logoutButton {
                float:right;
            }
            #onlineListDiv {
                /*background-color:blue;*/
                font-family:sans-serif;
                float:none;
            }
            #postButtonsDiv 
            {
                float:none;
                /*float:left;*/
            }
            .postText {
                float:none;
                display: none;
            }
            .post:disabled {
                font-family:fantasy;
                background-color:floralwhite;
                color:black;
            }
            .post:enabled{
                font-family:fantasy;
                background-color:floralwhite;
            }
            .makePostButton {
                float:none;
                display: block;
            }
            .thisUser {
                color:black;
                font-weight:bolder;
                text-decoration-line:underline;
                text-decoration-color: firebrick;
            }
            body {
                background-image:url(http://bigbackground.com/wp-content/uploads/2013/07/beach-screensavers-large2.jpg);
            }
        </style>
        </head>
    <body>
        <div class = "loginDiv" id = "loginDiv">
            <h1>
                Lab 11 Login Page
            </h1>
            <p class="loginFailed" id="loginFailed">Username/Password not found. Please try again.</p>
            <input type="text" name = "username" placeholder="Username" id="username">
            <input type="text" name = "password" placeholder="Password" id="password">
            <button class = "submitButton" id = "submitButton">Submit</button>
        </div>
        <div class = "postDiv" id = "postDiv">
            <div id="leftHalfDiv">
                <h1>
                    Lab 11 Post Page
                </h1>
                <div id="postListDiv">
                    <h1>Posts</h1>
                    
                    <dl id="postList">
                    </dl>
                </div>           
            </div>
            <p>
            <div id="rightHalfDiv">
                <h1>
                    Web-Post Application
                </h1>
                <h2>
                    <button class ="logoutButton" id="logoutButton">Logout</button>
                </h2>
                <div id="onlineListDiv">
                    <h1>Users Online</h1>
                    <ul id="onlineList">
                    </ul>
                </div>
                <div id="postButtonsDiv">
                    <h1>Make a Post</h1>
                    <textarea class = "postText" id="postText" rows=10 cols=30></textarea>
                    <button class = "makePostButton" id = "makePostButton">Make a Post</button>
                </div>
            </div>
        </p>
        </div>
        </body>
    <script>
$(document).ready(function() {
    
    /** SOCKETS BLOCK **/
        //Connect to websocket server.
        var socket = io.connect('ws://localhost:5000');
        
        //Listen for what to do after a login attempt.
        socket.on('loginResponse', function(loginSuccess) {
            if (loginSuccess) {
                console.log("Login successful.");
                onLoginSuccess();
            } else onLoginFailure();
        });
    
        // Listen for data to initialize page.
        socket.on('initializePage', function(data){
            
        });
    
        // Listen for data to alter post list.
        socket.on('updatePostList', function(data){
            console.log("Data: "+data);
            var postsList = JSON.parse(data);
            var items = [];
            $('#postList').empty();
            //How to add a text area in. 
            for (var item=postsList["posts"].length-1; item >= 0; item--){
                var thisJSONStr = JSON.stringify(postsList["posts"][item]);
                var thisJSONObj = JSON.parse(thisJSONStr);
                console.log("This item's json string is: "+thisJSONStr);
                var dtPostsNumber = thisJSONObj.id;
                var json = "<p class='json' hidden>"+thisJSONStr+"</p>";
                var author;
                var textarea;
                var timestamp = "<label class='timestamp'>["+thisJSONObj.timestamp+"]</label>";
                
                if (thisJSONObj.author==($('#username').val())){
                $('#postList').append(
                    $("<dt class='thisUser'>").append("Post #"+dtPostsNumber));
                    author = "<label class='thisUser'>["+thisJSONObj.author+"]: "+"</lable>";
                    textarea = "<textarea class='post' cols = 40 readonly>"+
                                thisJSONObj.data+
                                "</textarea>";
                } else {
                    $('#postList').append(
                        $('<dt>').append("Post #"+dtPostsNumber));
                    author = "<label class='author'>["+thisJSONObj.author+"]: "+"</lable>";
                    textarea = "<textarea class='post' cols = 40 disabled>"+
                                thisJSONObj.data+
                                "</textarea>";                    
                }

                var dd = "<dd class='value'>"+author+"<br>"+
                            textarea+"<br>"+timestamp+json+
                         "</dd>";
//                $('#postList').append($('<dd>').attr('class','value').append(
//                    $('<textarea></textrea>').attr(
//                        'class','post','cols',40,'readonly').text(
//                                "["+postsList["posts"][item].author+"]: " +
//                                "\n\n"+postsList["posts"][item].timestamp) +
//                    $('<p></p>').attr('class','json','hidden').text(json)
//                                    ));
                
                //console.log($('#postList').eq(item).contents());
                //dd = dd.replace(/(?:\r\n|\r|\n)/g, '<br />');
                $('#postList').append(dd+"<br>");
               // console.log("Item in user list: " + JSON.stringify(postsList["posts"][item]));
                //items.push(dt+dd);
            }
            //$('#postList').empty();
            //$('#postList').append(items);
//            var nodeList = document.getElementsByClassName("post");
//            for (var i = 0; i<nodeList.length;i++){
//                var domElement = nodeList[i];
//                var jqElement = $('#postList').eq(i);
//                console.log("Jquery Element: "+jqElement.text());
//                var fontheight = jqElement.css("font-size").replace(/[^-\d\.]/g, '');
//                console.log("Font height: "+fontheight);
//                var scrollheight = domElement.scrollHeight;
//                console.log("Scroll height: "+scrollheight);
//                var originalheight = jqElement.css("height").replace(/[^-\d\.]/g, '');
//                console.log("Original height: "+ originalheight);
//                jqElement.css("height",(scrollheight*fontheight)+"px");
//                var newheight = jqElement.css("height");
//                console.log("New height: "+newheight);
//            }
        });
    
        // Listen for data to alter online users list.
        socket.on('updateOnlineUsersList', function(data){
            console.log("Data: "+data);
            var usersList = JSON.parse(data);
            var items = [];
            for (var item in usersList["onlineUsers"]){
                var value;
                if (usersList["onlineUsers"][item]==($('#username').val())){
                    value = "<li class='thisUser'>"+usersList["onlineUsers"][item]+"</li>";
                }
                else {
                    value = "<li class='userOnline'>"+usersList["onlineUsers"][item]+"</li>";
                }
                console.log("Item in user list: " + usersList["onlineUsers"][item]);
                items.push(value);
            }
            $('#onlineList').empty();
            $('#onlineList').append(items);
        });
    
        console.log("Socket handlers have been set up.");
    
    /** BUTTON HANDLERS BLOCK **/
    
        // Submit button handler (submits a login attempt)
        $('#submitButton').click(function() {
            //Get username and password. 
            var uname = $('#username').val();
            var pword = $('#password').val();
            console.log("username and password: "+uname+", "+pword);
            //get password/username from loginDiv
            if ((uname ==null || uname =="") || 
                (pword ==null || pword=="")) {
                alert("Username and password must be filled out");
                return false;
            }
            
            var loginJSONObj = {
                "username": uname,
                "password": pword
            };
            
            var loginJSONStr = JSON.stringify(loginJSONObj);
            
            console.log("JSON Obj: "+loginJSONObj);
            console.log("JSON String: "+loginJSONStr);
            //websocket check to server
            socket.emit('validateLogin', loginJSONStr);

            console.log("validateLogin was emitted.");
            return;
        });
    
        $('#makePostButton').click(function(){
            $('#postText').val("");
            $('#makePostButton').css("display","none");
            $('#postText').css("display","block");
        });
    
        // Logout button handler.
        $('#logoutButton').click(function(){
            var uname = $('#username').val();
            var usernameJSONStr = JSON.stringify({"username":uname});
            socket.emit('logout', usernameJSONStr,function(){
                console.log("Logout successful.");
            });
            onLogoutSuccess();
        });
    
        $('#postDiv').find($('#postButtonsDiv')).delegate("textarea", "keydown", function(e){
            if (e.which==13 && !e.shiftKey){
                
                console.log("Enter button was pressed.");
                var author = $('#username').val();
                var data = $('#postText').val();
                var timestamp = new Date();
                
                var postJSONObj = {"author":author,"data":data,"timestamp":timestamp};
                console.log("Post object sent: "+JSON.stringify(postJSONObj));
                $('#postText').css("display","none");
                $('#makePostButton').css("display","block");
                $('#postText').val("");
                //send postVal
                socket.emit("newPost", postJSONObj);
            }
        });
        $('#postListDiv').delegate("dd","click", function(){
            var dd = $(this);
            var text =  dd.contents().filter(function(){
                return this.nodeType == 3;
            }).text();
            var jsonStr = ($(this).find('.json').text());
            console.log("jsonStr value: "+jsonStr);
            var jsonObj = JSON.parse(jsonStr);
            
            //console.log(text);
            console.log("Author: "+jsonObj.author);
            if ($('#username').val()==jsonObj.author){
                $(this).find('.post').removeAttr('readonly');
                $(this).delegate("textarea","keydown", function(e) {
                    if (e.which==13 && !e.shiftKey){
                        var newtext = $(this).val();
                        jsonObj["data"]=newtext;
                        console.log("Attempt to figure out textarea text: "+newtext);
                        //jsonObj['data']="foo";
                        socket.emit("editPost",jsonObj);
                        $(this).attr("readonly","readonly");
                        console.log("Json after edit: "+JSON.stringify(jsonObj));
                    }
                });
            }
        });
        function onLoginSuccess() {
            document.getElementById("loginDiv").style.display="none";
            document.getElementById("postDiv").style.display="block";
            socket.emit("loadData", $('#username').val());
        }
        function onLoginFailure() {
            document.getElementById("loginFailed").style.visibility="visible";
        }
    
    
        function displayPostList(arr) {

        }
        function appendPost(author, message) {

        }
        function displayOnlineList(arr) {
            var out = "";
            var i;
            for(i = 0; i<arr.length; i++) {
                out += arr[i].display + '<br>';
            }
            document.getElementById("onlineListDiv").innerHTML = out;
        }
        function logout() {
            //websocket update to server
            onLogoutSuccess();
        }
        function onLogoutSuccess() {
            document.getElementById("postDiv").style.display="none";
            document.getElementById("loginDiv").style.display="block";
            document.getElementById("loginFailed").style.visibility="hidden";
        }
        socket.on('loginResponse', function(loginSuccess) {
            if (loginSuccess) {
                onLoginSuccess();
            } else onLoginFailure();
        });
        socket.on('initializePage', function(data){
            
        });
        socket.on('updatePostList', function(data){
            
        });
        socket.on('updateOnlineUsersList', function(data){
            
        });
});
        </script>
</html>